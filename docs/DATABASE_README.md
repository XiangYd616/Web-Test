# æ•°æ®åº“æ¶æ„é‡æ„è¯´æ˜

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³é¡¹ç›®ä¸­æ•°æ®åº“æ¶æ„æ··ä¹±çš„é—®é¢˜ï¼Œå»ºç«‹å•ä¸€æƒå¨çš„æ•°æ®åº“æ¶æ„ã€‚

## âŒ ä¹‹å‰çš„é—®é¢˜

1. **å¤šä¸ªæ¶æ„æ–‡ä»¶å†²çª**ï¼š
   - `unified-optimized-database-schema.sql`
   - `optimized-database-schema.sql`
   - `master-detail-test-history-schema.sql`
   - `compatible-init-database.sql`

2. **å­—æ®µåä¸åŒ¹é…**ï¼š
   - ä»£ç ä¸­ä½¿ç”¨ `failed_login_attempts`ï¼ŒæŸäº›æ¶æ„ä¸­æ˜¯ `login_attempts`
   - ç¼ºå°‘ `refresh_tokens` å’Œ `user_sessions` è¡¨

3. **åˆå§‹åŒ–è„šæœ¬æ··ä¹±**ï¼š
   - å¤šä¸ªä¸åŒçš„åˆå§‹åŒ–è„šæœ¬
   - ä¸åŒçš„æ•°æ®åº“åç§°é…ç½®

## âœ… é‡æ„åçš„æ¶æ„

### æ ¸å¿ƒæ–‡ä»¶

1. **`database-schema.sql`** - æƒå¨æ•°æ®åº“æ¶æ„
   - ä¸ä»£ç å®Œå…¨åŒ¹é…çš„å­—æ®µå
   - åŒ…å«æ‰€æœ‰å¿…è¦çš„è¡¨å’Œç´¢å¼•
   - ç»Ÿä¸€çš„å‘½åè§„èŒƒ

2. **`init-db.js`** - ç»Ÿä¸€åˆå§‹åŒ–è„šæœ¬
   - é‡ç½®å¹¶åˆ›å»ºå®Œæ•´æ¶æ„
   - åˆ›å»ºæµ‹è¯•ç”¨æˆ·
   - éªŒè¯è¡¨ç»“æ„

3. **`cleanup-old-db-files.js`** - æ¸…ç†æ—§æ–‡ä»¶
   - ç§»é™¤é‡å¤çš„æ¶æ„æ–‡ä»¶
   - å¤‡ä»½é‡è¦æ–‡ä»¶

### æ•°æ®åº“è¡¨ç»“æ„

#### ç”¨æˆ·ç®¡ç†
- `users` - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå­—æ®µåä¸ä»£ç åŒ¹é…ï¼‰
- `refresh_tokens` - JWTåˆ·æ–°ä»¤ç‰Œ
- `user_sessions` - ç”¨æˆ·ä¼šè¯ç®¡ç†

#### æµ‹è¯•ç®¡ç†
- `test_sessions` - æµ‹è¯•ä¼šè¯è®°å½•

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æ¸…ç†æ—§æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
```bash
cd server
node cleanup-old-db-files.js
```

### 2. åˆå§‹åŒ–æ•°æ®åº“
```bash
cd server
node init-db.js
```

### 3. éªŒè¯
- æ£€æŸ¥è¡¨æ˜¯å¦æ­£ç¡®åˆ›å»º
- ä½¿ç”¨æµ‹è¯•è´¦æˆ·ç™»å½•ï¼š
  - é‚®ç®±: test@example.com
  - å¯†ç : 123456

## ğŸ“‹ å…³é”®å­—æ®µæ˜ å°„

### usersè¡¨å­—æ®µï¼ˆä¸ä»£ç åŒ¹é…ï¼‰
```sql
-- è®¤è¯å­—æ®µ
password_hash VARCHAR(255)           -- âœ“ ä¸ä»£ç åŒ¹é…
failed_login_attempts INTEGER        -- âœ“ ä¸ä»£ç åŒ¹é…
reset_token VARCHAR(255)             -- âœ“ ä¸ä»£ç åŒ¹é…
reset_token_expires TIMESTAMP        -- âœ“ ä¸ä»£ç åŒ¹é…

-- çŠ¶æ€å­—æ®µ
is_active BOOLEAN                    -- âœ“ ä¸ä»£ç åŒ¹é…
email_verified BOOLEAN               -- âœ“ ä¸ä»£ç åŒ¹é…
```

### æ–°å¢è¡¨
```sql
-- JWTç®¡ç†
refresh_tokens (id, user_id, token_hash, jti, expires_at, is_revoked)

-- ä¼šè¯ç®¡ç†  
user_sessions (id, user_id, session_id, access_token_hash, expires_at)
```

## ğŸ”§ ç»´æŠ¤æŒ‡å—

### æ·»åŠ æ–°è¡¨
1. åœ¨ `database-schema.sql` ä¸­æ·»åŠ è¡¨å®šä¹‰
2. æ·»åŠ ç›¸åº”çš„ç´¢å¼•
3. æ›´æ–° `init-db.js` ä¸­çš„éªŒè¯é€»è¾‘

### ä¿®æ”¹ç°æœ‰è¡¨
1. åˆ›å»ºè¿ç§»æ–‡ä»¶åœ¨ `migrations/` ç›®å½•
2. ä½¿ç”¨ `scripts/run-migrations.js` æ‰§è¡Œè¿ç§»
3. æ›´æ–° `database-schema.sql` ä»¥åæ˜ æœ€æ–°çŠ¶æ€

### å­—æ®µå‘½åè§„èŒƒ
- ä½¿ç”¨ `snake_case` å‘½å
- å¸ƒå°”å­—æ®µä½¿ç”¨ `is_` å‰ç¼€
- æ—¶é—´å­—æ®µä½¿ç”¨ `_at` åç¼€
- å¤–é”®ä½¿ç”¨ `_id` åç¼€

## ğŸš¨ é‡è¦æé†’

1. **ä¸è¦ç›´æ¥ä¿®æ”¹ç”Ÿäº§æ•°æ®åº“**
2. **å§‹ç»ˆå…ˆåœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•**
3. **ä¿æŒ `database-schema.sql` ä¸ºæƒå¨æ¶æ„**
4. **æ–°çš„æ•°æ®åº“æ›´æ”¹å¿…é¡»é€šè¿‡è¿ç§»ç³»ç»Ÿ**

## ğŸ“ æ•…éšœæ’é™¤

### ç™»å½•å¤±è´¥
1. æ£€æŸ¥ `users` è¡¨æ˜¯å¦å­˜åœ¨
2. éªŒè¯å­—æ®µåæ˜¯å¦åŒ¹é…ä»£ç 
3. ç¡®è®¤æµ‹è¯•ç”¨æˆ·æ˜¯å¦åˆ›å»ºæˆåŠŸ

### è¡¨ä¸å­˜åœ¨é”™è¯¯
1. è¿è¡Œ `node init-db.js` é‡æ–°åˆå§‹åŒ–
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®
3. éªŒè¯æƒé™è®¾ç½®

### å­—æ®µä¸åŒ¹é…
1. å¯¹æ¯” `database-schema.sql` å’Œä»£ç 
2. è¿è¡Œæ•°æ®åº“é‡ç½®
3. æ£€æŸ¥è¿ç§»æ˜¯å¦æ­£ç¡®æ‰§è¡Œ
