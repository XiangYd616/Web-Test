# Test-Web 系统流程图

## 1. 用户使用流程图

```mermaid
flowchart TD
    A[用户启动应用] --> B{选择访问方式}
    B -->|Web浏览器| C[访问 localhost:5174]
    B -->|桌面应用| D[启动 Electron App]
    
    C --> E[前端应用加载]
    D --> E
    
    E --> F{用户是否已登录}
    F -->|否| G[显示登录页面]
    F -->|是| H[显示仪表板]
    
    G --> I[用户输入凭据]
    I --> J[身份验证]
    J -->|成功| H
    J -->|失败| K[显示错误信息]
    K --> G
    
    H --> L{选择功能模块}
    L -->|压力测试| M[压力测试页面]
    L -->|内容检测| N[内容检测页面]
    L -->|兼容性测试| O[兼容性测试页面]
    L -->|SEO分析| P[SEO分析页面]
    L -->|系统设置| Q[设置页面]
    
    M --> R[输入测试参数]
    N --> S[输入检测URL]
    O --> T[选择浏览器配置]
    P --> U[输入分析URL]
    
    R --> V[执行测试]
    S --> V
    T --> V
    U --> V
    
    V --> W[显示实时进度]
    W --> X[生成测试报告]
    X --> Y[展示结果]
    Y --> Z[用户查看/下载报告]
```

## 2. 测试执行数据流程图

```mermaid
flowchart TD
    A[用户提交测试请求] --> B[前端数据验证]
    B -->|验证失败| C[显示错误信息]
    B -->|验证成功| D[发送API请求]
    
    D --> E[后端接收请求]
    E --> F[身份验证中间件]
    F -->|验证失败| G[返回401错误]
    F -->|验证成功| H[请求参数验证]
    
    H -->|验证失败| I[返回400错误]
    H -->|验证成功| J[路由分发]
    
    J --> K{测试类型判断}
    K -->|压力测试| L[压力测试引擎]
    K -->|内容检测| M[内容检测引擎]
    K -->|兼容性测试| N[兼容性测试引擎]
    K -->|SEO分析| O[SEO分析引擎]
    K -->|安全扫描| P[安全扫描引擎]
    
    L --> Q[调用Puppeteer]
    M --> R[调用Playwright]
    N --> S[调用Lighthouse]
    O --> T[调用Cheerio解析]
    P --> U[调用安全检测工具]
    
    Q --> V[执行测试逻辑]
    R --> V
    S --> V
    T --> V
    U --> V
    
    V --> W[收集测试数据]
    W --> X[数据处理与分析]
    X --> Y[生成测试报告]
    Y --> Z[保存到数据库]
    Z --> AA[返回结果给前端]
    
    AA --> BB[WebSocket推送进度]
    BB --> CC[前端更新UI]
    CC --> DD[显示测试结果]
```

## 3. API调用流程图

```mermaid
flowchart TD
    A[客户端发起API请求] --> B[Axios HTTP客户端]
    B --> C[统一API服务处理]
    C --> D[添加认证头]
    D --> E[请求拦截器]
    
    E --> F[缓存检查]
    F -->|缓存命中| G[返回缓存结果]
    F -->|缓存未命中| H[发送网络请求]
    
    H --> I[后端Express服务器]
    I --> J[CORS中间件]
    J --> K[认证中间件]
    K -->|认证失败| L[返回401]
    K -->|认证成功| M[路由中间件]
    
    M --> N[验证中间件]
    N -->|验证失败| O[返回400]
    N -->|验证成功| P[业务逻辑处理]
    
    P --> Q{需要数据库操作}
    Q -->|是| R[数据库查询/更新]
    Q -->|否| S[直接处理逻辑]
    
    R --> T[获取数据库结果]
    T --> U[业务逻辑处理]
    S --> U
    
    U --> V[格式化响应数据]
    V --> W[响应拦截器]
    W --> X[错误处理]
    X --> Y[返回HTTP响应]
    
    Y --> Z[客户端接收响应]
    Z --> AA[响应拦截器处理]
    AA --> BB[更新缓存]
    BB --> CC[错误处理]
    CC --> DD[返回结果给调用方]
    
    L --> AA
    O --> AA
    G --> DD
```

## 4. 认证与授权流程图

```mermaid
flowchart TD
    A[用户登录请求] --> B[输入用户名密码]
    B --> C[前端表单验证]
    C -->|验证失败| D[显示错误信息]
    C -->|验证成功| E[发送登录请求]
    
    E --> F[后端认证服务]
    F --> G[用户信息验证]
    G -->|验证失败| H[返回登录失败]
    G -->|验证成功| I{启用MFA?}
    
    I -->|否| J[生成JWT Token]
    I -->|是| K[发送MFA代码]
    
    K --> L[用户输入MFA代码]
    L --> M[验证MFA代码]
    M -->|验证失败| N[返回MFA失败]
    M -->|验证成功| J
    
    J --> O[生成设备指纹]
    O --> P[记录登录会话]
    P --> Q[返回Token对]
    
    Q --> R[前端存储Token]
    R --> S[设置自动刷新]
    S --> T[登录成功]
    
    %% Token刷新流程
    U[Token即将过期] --> V[自动刷新请求]
    V --> W[验证Refresh Token]
    W -->|无效| X[重定向登录页]
    W -->|有效| Y[生成新Token对]
    Y --> Z[更新本地存储]
    Z --> AA[继续会话]
    
    %% 权限检查流程
    BB[API请求] --> CC[检查Access Token]
    CC -->|无效/过期| DD[尝试刷新Token]
    CC -->|有效| EE[检查用户权限]
    
    DD --> V
    EE -->|无权限| FF[返回403错误]
    EE -->|有权限| GG[执行API逻辑]
```

## 5. 测试引擎执行流程图

```mermaid
flowchart TD
    A[测试请求到达] --> B[引擎注册中心]
    B --> C[查找合适的测试引擎]
    C -->|未找到| D[返回引擎不可用错误]
    C -->|找到| E[创建测试实例]
    
    E --> F[初始化测试配置]
    F --> G[验证测试参数]
    G -->|验证失败| H[返回参数错误]
    G -->|验证成功| I[启动测试引擎]
    
    I --> J{测试引擎类型}
    J -->|压力测试| K[压力测试引擎]
    J -->|内容检测| L[内容检测引擎]
    J -->|兼容性测试| M[兼容性测试引擎]
    J -->|SEO分析| N[SEO分析引擎]
    J -->|安全扫描| O[安全扫描引擎]
    
    %% 压力测试流程
    K --> K1[配置并发参数]
    K1 --> K2[启动多个测试进程]
    K2 --> K3[监控性能指标]
    K3 --> K4[收集响应数据]
    K4 --> P[生成测试报告]
    
    %% 内容检测流程
    L --> L1[页面内容抓取]
    L1 --> L2[内容安全分析]
    L2 --> L3[风险评估]
    L3 --> L4[生成检测报告]
    L4 --> P
    
    %% 兼容性测试流程
    M --> M1[多浏览器环境配置]
    M1 --> M2[并行执行测试]
    M2 --> M3[截图对比分析]
    M3 --> M4[兼容性评估]
    M4 --> P
    
    %% SEO分析流程
    N --> N1[页面结构分析]
    N1 --> N2[SEO指标检测]
    N2 --> N3[优化建议生成]
    N3 --> N4[SEO评分计算]
    N4 --> P
    
    %% 安全扫描流程
    O --> O1[漏洞扫描]
    O1 --> O2[安全检测]
    O2 --> O3[风险评级]
    O3 --> O4[修复建议]
    O4 --> P
    
    P --> Q[保存测试结果]
    Q --> R[通知前端完成]
    R --> S[WebSocket推送结果]
    S --> T[前端更新显示]
```

## 6. 数据库操作流程图

```mermaid
flowchart TD
    A[应用发起数据库请求] --> B[连接管理器]
    B --> C{连接池状态检查}
    C -->|无可用连接| D[等待连接]
    C -->|有可用连接| E[获取数据库连接]
    
    D --> F{等待超时?}
    F -->|是| G[返回连接超时错误]
    F -->|否| E
    
    E --> H[执行SQL查询]
    H --> I[查询结果处理]
    I --> J{查询是否成功}
    J -->|失败| K[错误处理]
    J -->|成功| L[返回查询结果]
    
    K --> M[记录错误日志]
    M --> N[释放连接]
    N --> O[返回错误信息]
    
    L --> P[数据格式化]
    P --> Q[释放连接回连接池]
    Q --> R[返回处理结果]
    
    %% 事务处理流程
    S[事务开始] --> T[开启数据库事务]
    T --> U[执行事务操作]
    U --> V{所有操作成功?}
    V -->|是| W[提交事务]
    V -->|否| X[回滚事务]
    
    W --> Y[事务提交成功]
    X --> Z[事务回滚完成]
    Y --> R
    Z --> O
```

## 7. 错误处理与监控流程图

```mermaid
flowchart TD
    A[系统错误发生] --> B[错误捕获]
    B --> C{错误类型判断}
    
    C -->|前端错误| D[前端错误边界]
    C -->|API错误| E[后端错误中间件]
    C -->|数据库错误| F[数据库错误处理]
    
    D --> G[记录前端错误日志]
    E --> H[记录API错误日志]
    F --> I[记录数据库错误日志]
    
    G --> J[错误信息格式化]
    H --> J
    I --> J
    
    J --> K[发送到监控系统]
    K --> L{错误级别判断}
    
    L -->|严重错误| M[立即告警通知]
    L -->|一般错误| N[记录错误统计]
    L -->|警告级别| O[定期汇总报告]
    
    M --> P[发送邮件/短信通知]
    N --> Q[错误统计分析]
    O --> R[生成监控报告]
    
    P --> S[运维人员处理]
    Q --> T[错误趋势分析]
    R --> U[系统健康报告]
    
    S --> V[问题修复]
    T --> W[优化建议]
    U --> X[性能改进建议]
```

## 8. WebSocket实时通信流程图

```mermaid
flowchart TD
    A[客户端连接WebSocket] --> B[建立WebSocket连接]
    B --> C[身份验证]
    C -->|验证失败| D[关闭连接]
    C -->|验证成功| E[注册客户端]
    
    E --> F[加入相应房间]
    F --> G[连接建立完成]
    
    %% 测试状态推送流程
    H[测试开始执行] --> I[生成状态更新事件]
    I --> J[查找相关客户端]
    J --> K[推送进度信息]
    K --> L[客户端接收更新]
    L --> M[更新UI显示]
    
    %% 实时监控流程
    N[系统性能监控] --> O[收集性能指标]
    O --> P[判断是否需要推送]
    P -->|是| Q[推送性能数据]
    P -->|否| R[继续监控]
    
    Q --> S[客户端更新仪表板]
    R --> O
    
    %% 错误通知流程
    T[系统错误发生] --> U[错误事件生成]
    U --> V[推送错误通知]
    V --> W[客户端显示错误]
    W --> X[用户确认处理]
```

## 流程图说明

### 🎯 关键流程特点

1. **用户体验优化**
   - 支持Web和桌面双模式访问
   - 统一的身份认证体验
   - 实时进度反馈

2. **安全性保障**
   - 多层次身份验证
   - JWT Token自动刷新
   - MFA多因素认证

3. **高可用性设计**
   - 连接池管理
   - 自动重试机制
   - 错误恢复策略

4. **实时性支持**
   - WebSocket实时通信
   - 进度状态推送
   - 监控数据更新

5. **模块化架构**
   - 测试引擎插件化
   - 中间件链式处理
   - 统一错误处理
