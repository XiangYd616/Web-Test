<!DOCTYPE html>
<html>
<head>
    <title>WebSocketè°ƒè¯•</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>WebSocketå®æ—¶ç›‘æ§è°ƒè¯•</h1>
    <div id="status">è¿æ¥çŠ¶æ€: æœªè¿æ¥</div>
    <button onclick="startTest()">å¯åŠ¨å‹åŠ›æµ‹è¯•</button>
    <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    <div id="logs"></div>
    
    <script>
        const socket = io('http://localhost:3001');
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        let currentTestId = null;
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${time}] ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
        }
        
        socket.on('connect', () => {
            statusDiv.textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥';
            statusDiv.style.color = 'green';
            log('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
        });
        
        socket.on('disconnect', () => {
            statusDiv.textContent = 'è¿æ¥çŠ¶æ€: å·²æ–­å¼€';
            statusDiv.style.color = 'red';
            log('âŒ WebSocketè¿æ¥æ–­å¼€', 'error');
        });
        
        socket.on('stress-test-data', (data) => {
            log(`ğŸ“Š æ”¶åˆ°å®æ—¶æ•°æ®: testId=${data.testId}`, 'success');
            log(`ğŸ“ˆ æŒ‡æ ‡: totalRequests=${data.metrics?.totalRequests}, currentTPS=${data.metrics?.currentTPS}, peakTPS=${data.metrics?.peakTPS}`, 'info');
            if (data.dataPoint) {
                log(`ğŸ“ æ•°æ®ç‚¹: responseTime=${data.dataPoint.responseTime}ms, throughput=${data.dataPoint.throughput}`, 'info');
            }
        });
        
        socket.on('stress-test-status', (data) => {
            log(`ğŸ“ˆ çŠ¶æ€æ›´æ–°: testId=${data.testId}, status=${data.status}, progress=${data.progress}%`, 'info');
        });
        
        socket.on('stress-test-complete', (data) => {
            log(`ğŸ æµ‹è¯•å®Œæˆ: testId=${data.testId}`, 'success');
        });
        
        async function startTest() {
            try {
                log('ğŸš€ å¯åŠ¨å‹åŠ›æµ‹è¯•...', 'info');
                
                const response = await fetch('http://localhost:3001/api/test/stress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: 'https://httpbin.org/delay/1',
                        options: {
                            users: 3,
                            duration: 15,
                            rampUpTime: 3,
                            testType: 'gradual',
                            method: 'GET',
                            timeout: 10,
                            thinkTime: 0.5
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTestId = data.data.testId;
                    log(`âœ… æµ‹è¯•å¯åŠ¨æˆåŠŸ, ID: ${currentTestId}`, 'success');
                    
                    // åŠ å…¥WebSocketæˆ¿é—´
                    socket.emit('join-stress-test', currentTestId);
                    log(`ğŸ  å·²å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚: ${currentTestId}`, 'info');
                } else {
                    log(`âŒ æµ‹è¯•å¯åŠ¨å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
