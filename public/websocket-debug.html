<!DOCTYPE html>
<html>
<head>
    <title>WebSocket调试</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>WebSocket实时监控调试</h1>
    <div id="status">连接状态: 未连接</div>
    <button onclick="startTest()">启动压力测试</button>
    <button onclick="clearLogs()">清空日志</button>
    <div id="logs"></div>
    
    <script>
        const socket = io('http://localhost:3001');
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        let currentTestId = null;
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${time}] ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
        }
        
        socket.on('connect', () => {
            statusDiv.textContent = '连接状态: 已连接';
            statusDiv.style.color = 'green';
            log('✅ WebSocket连接成功', 'success');
        });
        
        socket.on('disconnect', () => {
            statusDiv.textContent = '连接状态: 已断开';
            statusDiv.style.color = 'red';
            log('❌ WebSocket连接断开', 'error');
        });
        
        socket.on('stress-test-data', (data) => {
            log(`📊 收到实时数据: testId=${data.testId}`, 'success');
            log(`📈 指标: totalRequests=${data.metrics?.totalRequests}, currentTPS=${data.metrics?.currentTPS}, peakTPS=${data.metrics?.peakTPS}`, 'info');
            if (data.dataPoint) {
                log(`📍 数据点: responseTime=${data.dataPoint.responseTime}ms, throughput=${data.dataPoint.throughput}`, 'info');
            }
        });
        
        socket.on('stress-test-status', (data) => {
            log(`📈 状态更新: testId=${data.testId}, status=${data.status}, progress=${data.progress}%`, 'info');
        });
        
        socket.on('stress-test-complete', (data) => {
            log(`🏁 测试完成: testId=${data.testId}`, 'success');
        });
        
        async function startTest() {
            try {
                log('🚀 启动压力测试...', 'info');
                
                const response = await fetch('http://localhost:3001/api/test/stress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: 'https://httpbin.org/delay/1',
                        options: {
                            users: 3,
                            duration: 15,
                            rampUpTime: 3,
                            testType: 'gradual',
                            method: 'GET',
                            timeout: 10,
                            thinkTime: 0.5
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTestId = data.data.testId;
                    log(`✅ 测试启动成功, ID: ${currentTestId}`, 'success');
                    
                    // 加入WebSocket房间
                    socket.emit('join-stress-test', currentTestId);
                    log(`🏠 已发送加入房间请求: ${currentTestId}`, 'info');
                } else {
                    log(`❌ 测试启动失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 请求失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
