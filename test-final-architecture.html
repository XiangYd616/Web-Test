<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆæ¶æ„æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .log {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .important { color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ‰ æœ€ç»ˆæ¶æ„æµ‹è¯•</h1>
    
    <div class="section">
        <h2>é‡æ„å®Œæˆæ€»ç»“</h2>
        <p class="important">âœ… æ¶æ„é‡æ„å·²å®Œæˆï¼</p>
        <ul>
            <li>âœ… ç§»é™¤äº†å…¨å±€å‹åŠ›æµ‹è¯•å¼•æ“å®ä¾‹</li>
            <li>âœ… åˆ›å»ºäº†UserTestManagerç”¨æˆ·æµ‹è¯•ç®¡ç†å™¨</li>
            <li>âœ… ç®€åŒ–äº†WebSocketé€šä¿¡åè®®</li>
            <li>âœ… åŸºäºç”¨æˆ·IDçš„çŠ¶æ€ç®¡ç†</li>
            <li>âœ… æ·»åŠ äº†å›è°ƒæœºåˆ¶æ”¯æŒ</li>
            <li>âœ… ä¿®å¤äº†TestHistoryServiceç¼ºå¤±æ–¹æ³•</li>
            <li>âœ… æ›´æ–°äº†å‰ç«¯WebSocketåè®®</li>
        </ul>
    </div>

    <div class="section">
        <h2>å®Œæ•´åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <button onclick="testWebSocketProtocol()">æµ‹è¯•WebSocketåè®®</button>
        <button onclick="testAPIEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'important' ? 'important' : '';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        async function testCompleteFlow() {
            log('ğŸ§ª æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æµ‹è¯•æµç¨‹...', 'important');
            
            // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
            const mockUser = {
                id: 'test-user-' + Date.now(),
                username: 'test-user',
                email: 'test@example.com'
            };
            
            // å­˜å‚¨æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
            localStorage.setItem('user_data', JSON.stringify(mockUser));
            localStorage.setItem('auth_token', 'mock-token-' + Date.now());
            
            log(`ğŸ‘¤ æ¨¡æ‹Ÿç”¨æˆ·: ${mockUser.username} (${mockUser.id})`, 'info');

            try {
                // 1. æµ‹è¯•APIå†å²è®°å½•
                log('\n1ï¸âƒ£ æµ‹è¯•APIå†å²è®°å½•...', 'info');
                
                const historyResponse = await fetch('/api/test/history?type=stress&page=1&pageSize=5', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (historyResponse.ok) {
                    const historyData = await historyResponse.json();
                    log(`âœ… å†å²è®°å½•APIæ­£å¸¸: ${historyData.data?.tests?.length || 0} æ¡è®°å½•`, 'success');
                } else {
                    log(`âŒ å†å²è®°å½•APIå¤±è´¥: ${historyResponse.status}`, 'error');
                }

                // 2. æµ‹è¯•WebSocketè¿æ¥
                log('\n2ï¸âƒ£ æµ‹è¯•WebSocketè¿æ¥...', 'info');
                
                const socket = io();
                
                socket.on('connect', () => {
                    log(`âœ… WebSocketè¿æ¥æˆåŠŸ: ${socket.id}`, 'success');
                    
                    // æµ‹è¯•æ–°çš„åè®®æ ¼å¼
                    const testId = 'flow-test-' + Date.now();
                    socket.emit('join-stress-test', {
                        testId: testId,
                        userId: mockUser.id
                    });
                    
                    log(`ğŸ“¡ å‘é€è¿æ¥è¯·æ±‚: ${testId}`, 'info');
                });

                socket.on('room-joined', (data) => {
                    log(`âœ… è¿æ¥ç¡®è®¤: ${data.testId}`, 'success');
                    log(`ğŸ‘¤ ç”¨æˆ·ID: ${data.userId}`, 'info');
                    log(`ğŸ†” å®¢æˆ·ç«¯ID: ${data.clientId}`, 'info');
                });

                socket.on('test-progress', (data) => {
                    log(`ğŸ“Š è¿›åº¦æ›´æ–°: ${data.testId} - ${data.progress || 0}%`, 'info');
                });

                socket.on('test-completed', (data) => {
                    log(`âœ… æµ‹è¯•å®Œæˆ: ${data.testId}`, 'success');
                });

                socket.on('test-error', (data) => {
                    log(`âŒ æµ‹è¯•é”™è¯¯: ${data.testId} - ${data.error}`, 'error');
                });

                // 3. æµ‹è¯•å‹åŠ›æµ‹è¯•å¯åŠ¨
                setTimeout(async () => {
                    log('\n3ï¸âƒ£ æµ‹è¯•å‹åŠ›æµ‹è¯•å¯åŠ¨...', 'info');
                    
                    try {
                        const testConfig = {
                            url: 'https://httpbin.org/delay/1',
                            users: 2,
                            duration: 5,
                            rampUpTime: 1,
                            testType: 'gradual',
                            method: 'GET',
                            timeout: 5,
                            thinkTime: 1
                        };

                        const startResponse = await fetch('/api/test/stress', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                            },
                            body: JSON.stringify(testConfig)
                        });

                        if (startResponse.ok) {
                            const startData = await startResponse.json();
                            log(`âœ… å‹åŠ›æµ‹è¯•å¯åŠ¨æˆåŠŸ: ${startData.testId}`, 'success');
                            
                            // æµ‹è¯•çŠ¶æ€æŸ¥è¯¢
                            setTimeout(async () => {
                                try {
                                    const statusResponse = await fetch(`/api/test/stress/status/${startData.testId}`, {
                                        headers: {
                                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                                        }
                                    });

                                    if (statusResponse.ok) {
                                        const statusData = await statusResponse.json();
                                        log(`âœ… çŠ¶æ€æŸ¥è¯¢æˆåŠŸ: ${statusData.data?.status || 'unknown'}`, 'success');
                                    } else {
                                        log(`âŒ çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${statusResponse.status}`, 'error');
                                    }
                                } catch (error) {
                                    log(`âŒ çŠ¶æ€æŸ¥è¯¢å¼‚å¸¸: ${error.message}`, 'error');
                                }
                            }, 2000);

                        } else {
                            const errorData = await startResponse.text();
                            log(`âŒ å‹åŠ›æµ‹è¯•å¯åŠ¨å¤±è´¥: ${startResponse.status}`, 'error');
                            log(`ğŸ“„ é”™è¯¯å“åº”: ${errorData}`, 'error');
                        }

                    } catch (error) {
                        log(`âŒ å‹åŠ›æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                    }
                }, 1000);

                // æ¸…ç†è¿æ¥
                setTimeout(() => {
                    socket.disconnect();
                    log(`ğŸ”Œ WebSocketè¿æ¥å·²æ–­å¼€`, 'info');
                    log(`\nğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼`, 'important');
                }, 10000);

            } catch (error) {
                log(`âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testWebSocketProtocol() {
            log('ğŸŒ æµ‹è¯•WebSocketåè®®...', 'important');
            
            const mockUserId = 'ws-protocol-test-' + Date.now();
            const testId = 'protocol-test-' + Date.now();
            
            try {
                const socket = io();
                
                socket.on('connect', () => {
                    log(`âœ… WebSocketè¿æ¥: ${socket.id}`, 'success');
                    
                    // æµ‹è¯•æ–°åè®®æ ¼å¼
                    socket.emit('join-stress-test', {
                        testId: testId,
                        userId: mockUserId
                    });
                    
                    log(`ğŸ“¡ æ–°åè®®æ ¼å¼å‘é€: { testId: "${testId}", userId: "${mockUserId}" }`, 'info');
                });

                socket.on('room-joined', (data) => {
                    log(`âœ… åè®®æµ‹è¯•æˆåŠŸ!`, 'success');
                    log(`ğŸ“‹ è¿”å›æ•°æ®: ${JSON.stringify(data)}`, 'info');
                    
                    setTimeout(() => {
                        socket.disconnect();
                        log(`ğŸ”Œ åè®®æµ‹è¯•å®Œæˆ`, 'info');
                    }, 2000);
                });

                socket.on('connect_error', (error) => {
                    log(`âŒ WebSocketè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                });

            } catch (error) {
                log(`âŒ WebSocketåè®®æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testAPIEndpoints() {
            log('ğŸ”Œ æµ‹è¯•APIç«¯ç‚¹...', 'important');
            
            const endpoints = [
                { name: 'æµ‹è¯•å†å²', url: '/api/test/history?type=stress&page=1&pageSize=1' },
                { name: 'è¿è¡Œä¸­æµ‹è¯•', url: '/api/test/stress/running' },
                { name: 'å¥åº·æ£€æŸ¥', url: '/api/health' }
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`\nğŸ§ª æµ‹è¯•: ${endpoint.name}`, 'info');
                    
                    const response = await fetch(endpoint.url, {
                        headers: {
                            ...(localStorage.getItem('auth_token') ? {
                                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                            } : {})
                        }
                    });

                    if (response.ok) {
                        log(`âœ… ${endpoint.name} æ­£å¸¸: ${response.status}`, 'success');
                    } else {
                        log(`âŒ ${endpoint.name} å¤±è´¥: ${response.status}`, 'error');
                    }

                } catch (error) {
                    log(`âŒ ${endpoint.name} å¼‚å¸¸: ${error.message}`, 'error');
                }
            }
            
            log(`\nğŸ”Œ APIç«¯ç‚¹æµ‹è¯•å®Œæˆ`, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            log('ğŸŒ æœ€ç»ˆæ¶æ„æµ‹è¯•å·¥å…·å·²åŠ è½½', 'important');
            log('ğŸ‰ é‡æ„å®Œæˆçš„åŠŸèƒ½:', 'info');
            log('   1. ç”¨æˆ·çº§æµ‹è¯•ç®¡ç†', 'info');
            log('   2. ç®€åŒ–çš„WebSocketåè®®', 'info');
            log('   3. å›è°ƒæœºåˆ¶æ”¯æŒ', 'info');
            log('   4. å®Œå–„çš„é”™è¯¯å¤„ç†', 'info');
            log('   5. ç»Ÿä¸€çš„APIæ¥å£', 'info');
            log('\nğŸ§ª ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        };
    </script>
    
    <!-- Socket.IOå®¢æˆ·ç«¯ -->
    <script src="/socket.io/socket.io.js"></script>
</body>
</html>
