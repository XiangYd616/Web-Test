<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç†vsç›´æ¥è°ƒç”¨å¯¹æ¯”</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .log {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
    </style>
</head>
<body>
    <h1>ğŸ” ä»£ç†vsç›´æ¥è°ƒç”¨å¯¹æ¯”</h1>
    
    <div class="section">
        <h2>é—®é¢˜åˆ†æ</h2>
        <p>ç›´æ¥è°ƒç”¨åç«¯è¿”å›200ï¼Œä½†é€šè¿‡Viteä»£ç†è¿”å›400ã€‚è®©æˆ‘ä»¬å¯¹æ¯”ä¸¤ç§è°ƒç”¨æ–¹å¼çš„å·®å¼‚ï¼š</p>
    </div>

    <div class="section comparison">
        <div>
            <h3>é€šè¿‡Viteä»£ç†è°ƒç”¨</h3>
            <button onclick="testViaProxy()">æµ‹è¯•ä»£ç†è°ƒç”¨</button>
            <div id="proxyLog" class="log"></div>
        </div>
        <div>
            <h3>ç›´æ¥è°ƒç”¨åç«¯</h3>
            <button onclick="testDirectCall()">æµ‹è¯•ç›´æ¥è°ƒç”¨</button>
            <div id="directLog" class="log"></div>
        </div>
    </div>

    <div class="section">
        <button onclick="clearLogs()">æ¸…ç©ºæ‰€æœ‰æ—¥å¿—</button>
        <button onclick="compareResults()">å¯¹æ¯”ç»“æœ</button>
    </div>

    <script>
        let proxyResult = null;
        let directResult = null;

        function logToElement(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('proxyLog').innerHTML = '';
            document.getElementById('directLog').innerHTML = '';
            proxyResult = null;
            directResult = null;
        }

        async function testViaProxy() {
            logToElement('proxyLog', 'ğŸŒ é€šè¿‡Viteä»£ç†è°ƒç”¨API...', 'info');
            
            const url = `/api/test/history?type=stress&page=1&pageSize=10&sortBy=created_at&sortOrder=desc`;
            logToElement('proxyLog', `ğŸ“‹ URL: ${url}`, 'info');

            try {
                const startTime = performance.now();
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(localStorage.getItem('auth_token') ? {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        } : {})
                    }
                });
                const endTime = performance.now();

                logToElement('proxyLog', `ğŸ“Š çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                logToElement('proxyLog', `â±ï¸  è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`, 'info');

                // è®°å½•è¯·æ±‚å¤´
                logToElement('proxyLog', 'ğŸ“‹ è¯·æ±‚å¤´:', 'info');
                logToElement('proxyLog', `   Content-Type: application/json`, 'info');
                logToElement('proxyLog', `   Authorization: ${localStorage.getItem('auth_token') ? 'Bearer ***' : 'none'}`, 'info');

                // è®°å½•å“åº”å¤´
                logToElement('proxyLog', 'ğŸ“‹ å“åº”å¤´:', 'info');
                for (const [key, value] of response.headers.entries()) {
                    logToElement('proxyLog', `   ${key}: ${value}`, 'info');
                }

                const responseText = await response.text();
                logToElement('proxyLog', `ğŸ“„ å“åº”ä½“: ${responseText}`, 'info');

                proxyResult = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    body: responseText,
                    ok: response.ok
                };

                if (response.ok) {
                    logToElement('proxyLog', 'âœ… ä»£ç†è°ƒç”¨æˆåŠŸ', 'success');
                } else {
                    logToElement('proxyLog', 'âŒ ä»£ç†è°ƒç”¨å¤±è´¥', 'error');
                }

            } catch (error) {
                logToElement('proxyLog', `âŒ ä»£ç†è°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                proxyResult = { error: error.message };
            }
        }

        async function testDirectCall() {
            logToElement('directLog', 'ğŸ”— ç›´æ¥è°ƒç”¨åç«¯API...', 'info');
            
            const url = `http://localhost:3001/api/test/history?type=stress&page=1&pageSize=10&sortBy=created_at&sortOrder=desc`;
            logToElement('directLog', `ğŸ“‹ URL: ${url}`, 'info');

            try {
                const startTime = performance.now();
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(localStorage.getItem('auth_token') ? {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        } : {})
                    }
                });
                const endTime = performance.now();

                logToElement('directLog', `ğŸ“Š çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                logToElement('directLog', `â±ï¸  è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`, 'info');

                // è®°å½•è¯·æ±‚å¤´
                logToElement('directLog', 'ğŸ“‹ è¯·æ±‚å¤´:', 'info');
                logToElement('directLog', `   Content-Type: application/json`, 'info');
                logToElement('directLog', `   Authorization: ${localStorage.getItem('auth_token') ? 'Bearer ***' : 'none'}`, 'info');

                // è®°å½•å“åº”å¤´
                logToElement('directLog', 'ğŸ“‹ å“åº”å¤´:', 'info');
                for (const [key, value] of response.headers.entries()) {
                    logToElement('directLog', `   ${key}: ${value}`, 'info');
                }

                const responseText = await response.text();
                logToElement('directLog', `ğŸ“„ å“åº”ä½“: ${responseText}`, 'info');

                directResult = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    body: responseText,
                    ok: response.ok
                };

                if (response.ok) {
                    logToElement('directLog', 'âœ… ç›´æ¥è°ƒç”¨æˆåŠŸ', 'success');
                } else {
                    logToElement('directLog', 'âŒ ç›´æ¥è°ƒç”¨å¤±è´¥', 'error');
                }

            } catch (error) {
                logToElement('directLog', `âŒ ç›´æ¥è°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                logToElement('directLog', `ğŸ’¡ è¿™å¯èƒ½æ˜¯CORSé—®é¢˜ï¼Œå±äºæ­£å¸¸ç°è±¡`, 'warning');
                directResult = { error: error.message };
            }
        }

        function compareResults() {
            if (!proxyResult || !directResult) {
                alert('è¯·å…ˆæ‰§è¡Œä¸¤ç§è°ƒç”¨æ–¹å¼çš„æµ‹è¯•');
                return;
            }

            console.log('ğŸ” å¯¹æ¯”ç»“æœ:');
            console.log('ä»£ç†è°ƒç”¨ç»“æœ:', proxyResult);
            console.log('ç›´æ¥è°ƒç”¨ç»“æœ:', directResult);

            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå¯¹æ¯”
            const comparison = document.createElement('div');
            comparison.className = 'section';
            comparison.innerHTML = `
                <h2>ğŸ” å¯¹æ¯”ç»“æœ</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>ä»£ç†è°ƒç”¨</h3>
                        <p>çŠ¶æ€: ${proxyResult.status || 'N/A'} ${proxyResult.statusText || ''}</p>
                        <p>æˆåŠŸ: ${proxyResult.ok ? 'æ˜¯' : 'å¦'}</p>
                        ${proxyResult.error ? `<p class="error">é”™è¯¯: ${proxyResult.error}</p>` : ''}
                    </div>
                    <div>
                        <h3>ç›´æ¥è°ƒç”¨</h3>
                        <p>çŠ¶æ€: ${directResult.status || 'N/A'} ${directResult.statusText || ''}</p>
                        <p>æˆåŠŸ: ${directResult.ok ? 'æ˜¯' : 'å¦'}</p>
                        ${directResult.error ? `<p class="error">é”™è¯¯: ${directResult.error}</p>` : ''}
                    </div>
                </div>
            `;
            
            // ç§»é™¤ä¹‹å‰çš„å¯¹æ¯”ç»“æœ
            const existingComparison = document.querySelector('.comparison-result');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            comparison.className += ' comparison-result';
            document.body.appendChild(comparison);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            logToElement('proxyLog', 'å‡†å¤‡æµ‹è¯•Viteä»£ç†è°ƒç”¨...', 'info');
            logToElement('directLog', 'å‡†å¤‡æµ‹è¯•ç›´æ¥è°ƒç”¨...', 'info');
        };
    </script>
</body>
</html>
