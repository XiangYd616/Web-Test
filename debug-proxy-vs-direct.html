<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理vs直接调用对比</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .log {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
    </style>
</head>
<body>
    <h1>🔍 代理vs直接调用对比</h1>
    
    <div class="section">
        <h2>问题分析</h2>
        <p>直接调用后端返回200，但通过Vite代理返回400。让我们对比两种调用方式的差异：</p>
    </div>

    <div class="section comparison">
        <div>
            <h3>通过Vite代理调用</h3>
            <button onclick="testViaProxy()">测试代理调用</button>
            <div id="proxyLog" class="log"></div>
        </div>
        <div>
            <h3>直接调用后端</h3>
            <button onclick="testDirectCall()">测试直接调用</button>
            <div id="directLog" class="log"></div>
        </div>
    </div>

    <div class="section">
        <button onclick="clearLogs()">清空所有日志</button>
        <button onclick="compareResults()">对比结果</button>
    </div>

    <script>
        let proxyResult = null;
        let directResult = null;

        function logToElement(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('proxyLog').innerHTML = '';
            document.getElementById('directLog').innerHTML = '';
            proxyResult = null;
            directResult = null;
        }

        async function testViaProxy() {
            logToElement('proxyLog', '🌐 通过Vite代理调用API...', 'info');
            
            const url = `/api/test/history?type=stress&page=1&pageSize=10&sortBy=created_at&sortOrder=desc`;
            logToElement('proxyLog', `📋 URL: ${url}`, 'info');

            try {
                const startTime = performance.now();
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(localStorage.getItem('auth_token') ? {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        } : {})
                    }
                });
                const endTime = performance.now();

                logToElement('proxyLog', `📊 状态: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                logToElement('proxyLog', `⏱️  耗时: ${(endTime - startTime).toFixed(2)}ms`, 'info');

                // 记录请求头
                logToElement('proxyLog', '📋 请求头:', 'info');
                logToElement('proxyLog', `   Content-Type: application/json`, 'info');
                logToElement('proxyLog', `   Authorization: ${localStorage.getItem('auth_token') ? 'Bearer ***' : 'none'}`, 'info');

                // 记录响应头
                logToElement('proxyLog', '📋 响应头:', 'info');
                for (const [key, value] of response.headers.entries()) {
                    logToElement('proxyLog', `   ${key}: ${value}`, 'info');
                }

                const responseText = await response.text();
                logToElement('proxyLog', `📄 响应体: ${responseText}`, 'info');

                proxyResult = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    body: responseText,
                    ok: response.ok
                };

                if (response.ok) {
                    logToElement('proxyLog', '✅ 代理调用成功', 'success');
                } else {
                    logToElement('proxyLog', '❌ 代理调用失败', 'error');
                }

            } catch (error) {
                logToElement('proxyLog', `❌ 代理调用异常: ${error.message}`, 'error');
                proxyResult = { error: error.message };
            }
        }

        async function testDirectCall() {
            logToElement('directLog', '🔗 直接调用后端API...', 'info');
            
            const url = `http://localhost:3001/api/test/history?type=stress&page=1&pageSize=10&sortBy=created_at&sortOrder=desc`;
            logToElement('directLog', `📋 URL: ${url}`, 'info');

            try {
                const startTime = performance.now();
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(localStorage.getItem('auth_token') ? {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        } : {})
                    }
                });
                const endTime = performance.now();

                logToElement('directLog', `📊 状态: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                logToElement('directLog', `⏱️  耗时: ${(endTime - startTime).toFixed(2)}ms`, 'info');

                // 记录请求头
                logToElement('directLog', '📋 请求头:', 'info');
                logToElement('directLog', `   Content-Type: application/json`, 'info');
                logToElement('directLog', `   Authorization: ${localStorage.getItem('auth_token') ? 'Bearer ***' : 'none'}`, 'info');

                // 记录响应头
                logToElement('directLog', '📋 响应头:', 'info');
                for (const [key, value] of response.headers.entries()) {
                    logToElement('directLog', `   ${key}: ${value}`, 'info');
                }

                const responseText = await response.text();
                logToElement('directLog', `📄 响应体: ${responseText}`, 'info');

                directResult = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    body: responseText,
                    ok: response.ok
                };

                if (response.ok) {
                    logToElement('directLog', '✅ 直接调用成功', 'success');
                } else {
                    logToElement('directLog', '❌ 直接调用失败', 'error');
                }

            } catch (error) {
                logToElement('directLog', `❌ 直接调用异常: ${error.message}`, 'error');
                logToElement('directLog', `💡 这可能是CORS问题，属于正常现象`, 'warning');
                directResult = { error: error.message };
            }
        }

        function compareResults() {
            if (!proxyResult || !directResult) {
                alert('请先执行两种调用方式的测试');
                return;
            }

            console.log('🔍 对比结果:');
            console.log('代理调用结果:', proxyResult);
            console.log('直接调用结果:', directResult);

            // 在页面上显示对比
            const comparison = document.createElement('div');
            comparison.className = 'section';
            comparison.innerHTML = `
                <h2>🔍 对比结果</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>代理调用</h3>
                        <p>状态: ${proxyResult.status || 'N/A'} ${proxyResult.statusText || ''}</p>
                        <p>成功: ${proxyResult.ok ? '是' : '否'}</p>
                        ${proxyResult.error ? `<p class="error">错误: ${proxyResult.error}</p>` : ''}
                    </div>
                    <div>
                        <h3>直接调用</h3>
                        <p>状态: ${directResult.status || 'N/A'} ${directResult.statusText || ''}</p>
                        <p>成功: ${directResult.ok ? '是' : '否'}</p>
                        ${directResult.error ? `<p class="error">错误: ${directResult.error}</p>` : ''}
                    </div>
                </div>
            `;
            
            // 移除之前的对比结果
            const existingComparison = document.querySelector('.comparison-result');
            if (existingComparison) {
                existingComparison.remove();
            }
            
            comparison.className += ' comparison-result';
            document.body.appendChild(comparison);
        }

        // 页面加载时显示说明
        window.onload = function() {
            logToElement('proxyLog', '准备测试Vite代理调用...', 'info');
            logToElement('directLog', '准备测试直接调用...', 'info');
        };
    </script>
</body>
</html>
