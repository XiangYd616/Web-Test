/**
 * MFAè®¾ç½®å‘å¯¼ç»„ä»¶
 * æä¾›åˆ†æ­¥éª¤çš„MFAè®¾ç½®å¼•å¯¼æµç¨‹ï¼ŒåŒ…æ‹¬ä»‹ç»ã€è®¾ç½®ã€éªŒè¯å’Œå®Œæˆæ­¥éª¤
 * ç‰ˆæœ¬: v1.0.0
 */

import React, { useState } from 'react';
import {
  ArrowLeft,
  ArrowRight,
  Check,
  CheckCircle,
  Download,
  Key,
  QrCode,
  Shield,
  ShieldCheck,
  Smartphone,
  Users,
  Zap
} from 'lucide-react';
import { MFASetup } from './MFASetup';

// ==================== ç±»å‹å®šä¹‰ ====================

export interface MFAWizardProps {
  userId: string;
  userEmail: string;
  onComplete?: () => void;
  onCancel?: () => void;
  className?: string;
}

type WizardStep = 'intro' | 'benefits' | 'setup' | 'verify' | 'complete';

interface BenefitItem {
  icon: React.ReactNode;
  title: string;
  description: string;
}

interface FeatureItem {
  icon: React.ReactNode;
  title: string;
  description: string;
}

// ==================== ä¸»ç»„?====================

export const MFAWizard: React.FC<MFAWizardProps> = ({
  userId,
  userEmail,
  onComplete,
  onCancel,
  className = ''
}) => {
  const [currentStep, setCurrentStep] = useState<WizardStep>('intro');
  const [_setupComplete, setSetupComplete] = useState(false);

  const steps: Record<WizardStep, { title: string; description: string }> = {
    intro: { title: 'æ¬¢è¿ä½¿ç”¨å¤šå› ç´ è®¤?, description: 'æå‡è´¦æˆ·å®‰å…¨æ€§çš„é‡è¦ä¸€? },
    benefits: { title: 'äº†è§£MFAçš„ä¼˜?, description: 'ä¸ºä»€ä¹ˆéœ€è¦åŒå› ç´ è®¤è¯' },
    setup: { title: 'è®¾ç½®èº«ä»½éªŒè¯?, description: 'é…ç½®æ‚¨çš„éªŒè¯åº”ç”¨' },
    verify: { title: 'éªŒè¯è®¾ç½®', description: 'ç¡®è®¤ä¸€åˆ‡å·¥ä½œæ­£? },
    complete: { title: 'è®¾ç½®å®Œæˆ', description: 'æ‚¨çš„è´¦æˆ·ç°åœ¨æ›´å®‰å…¨äº†' }
  };

  const benefits: BenefitItem[] = [
    {
      icon: <Shield className="w-8 h-8 text-blue-400" />,
      title: 'é¢å¤–å®‰å…¨ä¿æŠ¤',
      description: 'å³ä½¿å¯†ç è¢«æ³„éœ²ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•è®¿é—®æ‚¨çš„è´¦æˆ·'
    },
    {
      icon: <Key className="w-8 h-8 text-green-400" />,
      title: 'é˜²æ­¢æœªæˆæƒè®¿?,
      description: 'æ¯æ¬¡ç™»å½•éƒ½éœ€è¦æ‚¨çš„è®¾å¤‡ç”Ÿæˆçš„å”¯ä¸€éªŒè¯?
    },
    {
      icon: <Zap className="w-8 h-8 text-yellow-400" />,
      title: 'å¿«é€Ÿä¾¿?,
      description: 'ä½¿ç”¨èº«ä»½éªŒè¯å™¨åº”ç”¨åªéœ€å‡ ç§’é’Ÿå³å¯å®ŒæˆéªŒ?
    }
  ];

  const features: FeatureItem[] = [
    {
      icon: <Smartphone className="w-6 h-6 text-blue-400" />,
      title: 'å¤šç§èº«ä»½éªŒè¯å™¨æ”¯?,
      description: 'Google Authenticatorã€Microsoft Authenticatorã€Authy?
    },
    {
      icon: <Download className="w-6 h-6 text-green-400" />,
      title: 'å¤‡ç”¨ç ä¿?,
      description: 'æä¾›å¤‡ç”¨æ¢å¤ä»£ç ï¼Œé˜²æ­¢è®¾å¤‡ä¸¢å¤±æ—¶æ— æ³•ç™»å½•'
    },
    {
      icon: <Users className="w-6 h-6 text-purple-400" />,
      title: 'ä¼ä¸šçº§å®‰?,
      description: 'ç¬¦åˆè¡Œä¸šå®‰å…¨æ ‡å‡†ï¼Œä¿æŠ¤ä¼ä¸šå’Œä¸ªäººæ•°æ®'
    }
  ];

  const handleNext = () => {
    const stepOrder: WizardStep[] = ['intro', 'benefits', 'setup', 'verify', 'complete'];

    /**

     * ifåŠŸèƒ½å‡½æ•°

     * @param {Object} params - å‚æ•°å¯¹è±¡

     * @returns {Promise<Object>} è¿”å›ç»“æœ

     */
    const currentIndex = stepOrder.indexOf(currentStep);
    if (currentIndex < stepOrder.length - 1) {
      setCurrentStep(stepOrder[currentIndex + 1]);
    }
  };

  const handlePrevious = () => {
    const stepOrder: WizardStep[] = ['intro', 'benefits', 'setup', 'verify', 'complete'];

    /**

     * ifåŠŸèƒ½å‡½æ•°

     * @param {Object} params - å‚æ•°å¯¹è±¡

     * @returns {Promise<Object>} è¿”å›ç»“æœ

     */
    const currentIndex = stepOrder.indexOf(currentStep);
    if (currentIndex > 0) {
      setCurrentStep(stepOrder[currentIndex - 1]);
    }
  };

  const handleSetupComplete = () => {
    setSetupComplete(true);
    setCurrentStep('complete');
  };

  const handleFinish = () => {
    onComplete?.();
  };

  const renderProgressBar = () => {
    const stepOrder: WizardStep[] = ['intro', 'benefits', 'setup', 'verify', 'complete'];
    const currentIndex = stepOrder.indexOf(currentStep);
    const progress = ((currentIndex + 1) / stepOrder.length) * 100;

    return (
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium text-gray-300">è®¾ç½®è¿›åº¦</span>
          <span className="text-sm font-medium text-blue-400">{currentIndex + 1}/{stepOrder.length}</span>
        </div>
        <div className="w-full bg-gray-700 rounded-full h-2">
          <div 
            className="bg-blue-500 h-2 rounded-full transition-all duration-300 ease-out"
            style={{ width: `${progress}%` }}
          ></div>
        </div>
      </div>
    );
  };

  const renderIntroStep = () => (
    <div className="text-center space-y-6">
      <div className="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto">
        <Shield className="w-10 h-10 text-white" />
      </div>
      
      <div>
        <h1 className="text-2xl font-bold text-white mb-4">
          ä¿æŠ¤æ‚¨çš„ TestWeb è´¦æˆ·
        </h1>
        <p className="text-gray-400 text-lg leading-relaxed">
          é€šè¿‡å¯ç”¨å¤šå› ç´ è®¤?MFA)ï¼Œä¸ºæ‚¨çš„è´¦æˆ·æ·»åŠ é¢å¤–çš„å®‰å…¨ä¿æŠ¤å±‚?
          è¿™åªéœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œä½†èƒ½å¤§å¤§æé«˜æ‚¨è´¦æˆ·çš„å®‰å…¨æ€§?
        </p>
      </div>

      <div className="bg-blue-900/30 border border-blue-700 rounded-lg p-6">
        <div className="flex items-start space-x-3">
          <ShieldCheck className="w-6 h-6 text-blue-400 mt-0.5" />
          <div className="text-left">
            <h3 className="font-medium text-blue-200 mb-2">ä¸ºä»€ä¹ˆé€‰æ‹©MFA?/h3>
            <p className="text-blue-300 text-sm leading-relaxed">
              æ ¹æ®ç ”ç©¶ï¼Œå¯ç”¨MFAå¯ä»¥é˜»æ­¢99.9%çš„è‡ªåŠ¨åŒ–æ”»å‡»ã€‚å³ä½¿æ‚¨çš„å¯†ç è¢«æ³„éœ²?
              æ”»å‡»è€…ä»ç„¶æ— æ³•è®¿é—®æ‚¨çš„è´¦æˆ·?
            </p>
          </div>
        </div>
      </div>

      <div className="flex space-x-3">
        <button
          onClick={onCancel}
          className="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors"
        >
          ç¨åè®¾ç½®
        </button>
        <button
          onClick={handleNext}
          className="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center"
        >
          å¼€å§‹è®¾?
          <ArrowRight className="w-4 h-4 ml-2" />
        </button>
      </div>
    </div>
  );

  const renderBenefitsStep = () => (
    <div className="space-y-6">
      <div className="text-center">
        <div className="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <CheckCircle className="w-8 h-8 text-white" />
        </div>
        <h2 className="text-xl font-semibold text-white mb-2">MFAçš„ä¸»è¦ä¼˜?/h2>
        <p className="text-gray-400">äº†è§£å¤šå› ç´ è®¤è¯å¦‚ä½•ä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰?/p>
      </div>

      <div className="space-y-4">
        {benefits.map((benefit, index) => (
          <div 
            key={index}
            className="bg-gray-800 rounded-lg p-4 border border-gray-700"
          >
            <div className="flex items-start space-x-4">
              <div className="w-12 h-12 rounded-lg bg-gray-700 flex items-center justify-center flex-shrink-0">
                {benefit.icon}
              </div>
              <div>
                <h3 className="font-medium text-white mb-1">{benefit.title}</h3>
                <p className="text-gray-400 text-sm leading-relaxed">
                  {benefit.description}
                </p>
              </div>
            </div>
          </div>
        ))}
      </div>

      <div className="bg-gray-800 rounded-lg p-4">
        <h3 className="font-medium text-white mb-3">æ”¯æŒçš„åŠŸ?/h3>
        <div className="space-y-3">
          {features.map((feature, index) => (
            <div key={index} className="flex items-center space-x-3">
              <div className="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0">
                {feature.icon}
              </div>
              <div>
                <span className="text-white text-sm font-medium">{feature.title}</span>
                <p className="text-gray-400 text-xs">{feature.description}</p>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="flex space-x-3">
        <button
          onClick={handlePrevious}
          className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors flex items-center justify-center"
        >
          <ArrowLeft className="w-4 h-4 mr-2" />
          ä¸Šä¸€?
        </button>
        <button
          onClick={handleNext}
          className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center"
        >
          ç»§ç»­è®¾ç½®
          <ArrowRight className="w-4 h-4 ml-2" />
        </button>
      </div>
    </div>
  );

  const renderSetupStep = () => (
    <div className="space-y-6">
      <div className="text-center">
        <div className="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <QrCode className="w-8 h-8 text-white" />
        </div>
        <h2 className="text-xl font-semibold text-white mb-2">è®¾ç½®èº«ä»½éªŒè¯?/h2>
        <p className="text-gray-400">æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤é…ç½®æ‚¨çš„èº«ä»½éªŒè¯å™¨åº”ç”¨</p>
      </div>

      <MFASetup
        userId={userId}
        userEmail={userEmail}
        onSetupComplete={handleSetupComplete}
        onClose={() => setCurrentStep('benefits')}
      />

      <div className="flex justify-center">
        <button
          onClick={handlePrevious}
          className="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors flex items-center"
        >
          <ArrowLeft className="w-4 h-4 mr-2" />
          è¿”å›ä¸Šä¸€?
        </button>
      </div>
    </div>
  );

  const renderCompleteStep = () => (
    <div className="text-center space-y-6">
      <div className="w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mx-auto">
        <Check className="w-10 h-10 text-white" />
      </div>
      
      <div>
        <h1 className="text-2xl font-bold text-white mb-4">
          ğŸ‰ MFAè®¾ç½®å®Œæˆ?
        </h1>
        <p className="text-gray-400 text-lg leading-relaxed">
          æ­å–œï¼æ‚¨å·²ç»æˆåŠŸä¸ºè´¦æˆ·å¯ç”¨äº†å¤šå› ç´ è®¤è¯?
          æ‚¨çš„ TestWeb è´¦æˆ·ç°åœ¨å—åˆ°äº†é¢å¤–çš„å®‰å…¨ä¿æŠ¤?
        </p>
      </div>

      <div className="bg-green-900/30 border border-green-700 rounded-lg p-6">
        <div className="grid grid-cols-2 gap-4 text-center">
          <div>
            <div className="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-2">
              <Shield className="w-4 h-4 text-white" />
            </div>
            <p className="text-green-200 text-sm font-medium">è´¦æˆ·å®‰å…¨</p>
            <p className="text-green-300 text-xs">å¤§å¹…æå‡</p>
          </div>
          <div>
            <div className="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-2">
              <Key className="w-4 h-4 text-white" />
            </div>
            <p className="text-green-200 text-sm font-medium">å¤‡ç”¨?/p>
            <p className="text-green-300 text-xs">å·²ç”Ÿ?/p>
          </div>
        </div>
      </div>

      <div className="bg-blue-900/30 border border-blue-700 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <ShieldCheck className="w-5 h-5 text-blue-400 mt-0.5" />
          <div className="text-left text-sm">
            <h3 className="font-medium text-blue-200 mb-1">ä¸‹æ¬¡ç™»å½•æé†’</h3>
            <p className="text-blue-300">
              ä¸‹æ¬¡ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šè¦æ±‚æ‚¨è¾“å…¥èº«ä»½éªŒè¯å™¨åº”ç”¨ä¸­çš„éªŒè¯ç ?
              è¯·ç¡®ä¿æ‚¨çš„æ‰‹æœºä¸Šå·²å®‰è£…å¹¶è®¾ç½®å¥½äº†èº«ä»½éªŒè¯å™¨åº”ç”¨?
            </p>
          </div>
        </div>
      </div>

      <div className="space-y-3">
        <button
          onClick={handleFinish}
          className="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium"
        >
          å®Œæˆè®¾ç½®
        </button>
        
        <div className="flex space-x-3">
          <button
            onClick={() => setCurrentStep('setup')}
            className="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition-colors text-sm"
          >
            é‡æ–°è®¾ç½®
          </button>
          <button
            onClick={() => {/* è¿™é‡Œå¯ä»¥é“¾æ¥åˆ°å¸®åŠ©é¡µ?*/}}
            className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm"
          >
            æŸ¥çœ‹å¸®åŠ©
          </button>
        </div>
      </div>
    </div>
  );

  const renderCurrentStep = () => {
    switch (currentStep) {
      case 'intro':
        return renderIntroStep();
      case 'benefits':
        return renderBenefitsStep();
      case 'setup':
        return renderSetupStep();
      case 'complete':
        return renderCompleteStep();
      default:
        return renderIntroStep();
    }
  };

  return (
    <div className={`max-w-2xl mx-auto ${className}`}>
      <div className="bg-gray-900 rounded-lg p-8">
        {/* æ­¥éª¤æ ‡é¢˜ */}
        {currentStep !== 'intro' && currentStep !== 'complete' && (
          <div className="text-center mb-6">
            <h1 className="text-xl font-semibold text-white mb-1">
              {steps[currentStep].title}
            </h1>
            <p className="text-gray-400 text-sm">
              {steps[currentStep].description}
            </p>
          </div>
        )}

        {/* è¿›åº¦?*/}
        {currentStep !== 'intro' && currentStep !== 'complete' && renderProgressBar()}

        {/* å½“å‰æ­¥éª¤å†…å®¹ */}
        {renderCurrentStep()}
      </div>
    </div>
  );
};

export default MFAWizard;
